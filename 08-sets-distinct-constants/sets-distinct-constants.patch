From 587d1aaf8a429afe1ccbbc6d876d170a79c34b38 Mon Sep 17 00:00:00 2001
From: GitHub Copilot <copilot@github.com>
Date: Wed, 8 Oct 2025 14:15:56 +0000
Subject: [PATCH] Optimize syntax-quote for sets with distinct constants (fixed
 constant detection)

---
 src/jvm/clojure/lang/LispReader.java | 53 +++++++++++++++++++++++++++-
 1 file changed, 52 insertions(+), 1 deletion(-)

diff --git a/src/jvm/clojure/lang/LispReader.java b/src/jvm/clojure/lang/LispReader.java
index 8d7079c..fd335cb 100644
--- a/src/jvm/clojure/lang/LispReader.java
+++ b/src/jvm/clojure/lang/LispReader.java
@@ -1101,7 +1101,58 @@ public static class SyntaxQuoteReader extends AFn{
 				}
 			else if(form instanceof IPersistentSet)
 				{
-				ret = RT.list(APPLY, HASHSET, RT.list(SEQ, RT.cons(CONCAT, sqExpandList(((IPersistentSet) form).seq()))));
+				ISeq seq = ((IPersistentSet) form).seq();
+				// Check if all elements are distinct constants
+				boolean hasDistinctConstants = false;
+				if(seq != null)
+					{
+					hasDistinctConstants = true;
+					PersistentVector elements = PersistentVector.EMPTY;
+					// Check each element
+					for(ISeq s = seq; s != null; s = s.next())
+						{
+						Object element = s.first();
+						// Element must be a self-evaluating constant (keyword, number, string, boolean, nil, char)
+						if(isUnquote(element) || isUnquoteSplicing(element) ||
+						   (element instanceof Symbol) ||
+						   (element instanceof ISeq) ||
+						   (element instanceof IPersistentCollection && !(element instanceof Keyword)))
+							{
+							hasDistinctConstants = false;
+							break;
+							}
+						// Check if this element is distinct from previous elements
+						for(ISeq e = elements.seq(); e != null; e = e.next())
+							{
+							if(Util.equiv(e.first(), element))
+								{
+								hasDistinctConstants = false;
+								break;
+								}
+							}
+						if(!hasDistinctConstants)
+							break;
+						elements = elements.cons(element);
+						}
+					}
+				// `#{:a :b :c} => #{:a :b :c} (if all elements are distinct constants)
+				if(hasDistinctConstants && seq != null)
+					{
+					// Expand each element through syntax-quote
+					PersistentVector expanded = PersistentVector.EMPTY;
+					for(ISeq s = seq; s != null; s = s.next())
+						{
+						Object item = s.first();
+						if(isUnquote(item))
+							expanded = expanded.cons(RT.second(item));
+						else
+							expanded = expanded.cons(syntaxQuote(item));
+						}
+					ret = PersistentHashSet.create(RT.toArray(expanded));
+					}
+				else
+					ret = RT.list(APPLY, HASHSET, RT.list(SEQ, RT.cons(CONCAT, sqExpandList(seq))));
+				}
 				}
 			else if(form instanceof ISeq || form instanceof IPersistentList)
 				{
-- 
2.51.0

